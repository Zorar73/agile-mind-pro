rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isApproved() {
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role != 'pending';
    }
    
    // Пользователи
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isAdmin() || userId == request.auth.uid;
    }
    
    // Доски
    match /boards/{boardId} {
      allow read: if isApproved() && 
        resource.data.members[request.auth.uid] != null;
      allow create: if isApproved();
      allow update, delete: if isApproved() && 
        (resource.data.ownerId == request.auth.uid || 
         resource.data.members[request.auth.uid] == 'owner');
      
      // Колонки
      match /columns/{columnId} {
        allow read, write: if isApproved() && 
          get(/databases/$(database)/documents/boards/$(boardId)).data.members[request.auth.uid] != null;
      }
      
      // Задачи
      match /tasks/{taskId} {
        allow read, write: if isApproved() && 
          get(/databases/$(database)/documents/boards/$(boardId)).data.members[request.auth.uid] != null;
        
        // Комментарии
        match /comments/{commentId} {
          allow read, write: if isApproved();
        }
        
        // История (ИСПРАВЛЕНО!)
        match /activity/{activityId} {
          allow read: if isApproved();
          allow write: if isApproved(); // ← БЫЛО: if false
        }
      }
    }
  }
}