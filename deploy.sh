#!/bin/bash

# ================================================================
# DEPLOY SCRIPT ะะะฏ TIMEWEB CLOUD
# ะะฒัะพะผะฐัะธัะตัะบะธะน ะดะตะฟะปะพะน Agile Mind Pro ะฝะฐ ัะตัะฒะตั
# ================================================================

# ะฆะฒะตัะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ะคัะฝะบัะธะธ ะฒัะฒะพะดะฐ
error() { echo -e "${RED}$1${NC}"; }
success() { echo -e "${GREEN}$1${NC}"; }
info() { echo -e "${CYAN}$1${NC}"; }
warning() { echo -e "${YELLOW}$1${NC}"; }

# ะะฐัะฐะผะตััั
SERVER_IP=""
SKIP_BUILD=false

# ะะฐััะธะฝะณ ะฐัะณัะผะตะฝัะพะฒ
while [[ $# -gt 0 ]]; do
    case $1 in
        -s|--server)
            SERVER_IP="$2"
            shift 2
            ;;
        --skip-build)
            SKIP_BUILD=true
            shift
            ;;
        -h|--help)
            info "
๐ DEPLOY SCRIPT ะดะปั Agile Mind Pro

ะะกะะะะฌะะะะะะะ:
  ./deploy.sh -s <IP_ะฐะดัะตั_ัะตัะฒะตัะฐ>

ะะะะะะะขะะซ:
  -s, --server <IP>    IP ะฐะดัะตั ัะตัะฒะตัะฐ Timeweb Cloud (ะพะฑัะทะฐัะตะปัะฝะพ)
  --skip-build         ะัะพะฟัััะธัั build (ะตัะปะธ ัะถะต ัะพะฑัะฐะฝ)
  -h, --help           ะะพะบะฐะทะฐัั ััั ัะฟัะฐะฒะบั

ะะะะะะะซ:
  # ะะพะปะฝัะน ะดะตะฟะปะพะน
  ./deploy.sh -s 85.192.34.56

  # ะะตะฟะปะพะน ะฑะตะท ะฟะตัะตัะฑะพัะบะธ
  ./deploy.sh -s 85.192.34.56 --skip-build

ะะะะะซะ ะะะะฃะกะ:
  1. ะกะพะทะดะฐะน ัะตัะฒะตั ะฒ Timeweb Cloud
  2. ะะฐัััะพะน DNS ะฝะฐ Reg.ru (A-ะทะฐะฟะธัั ะฝะฐ IP ัะตัะฒะตัะฐ)
  3. ะะฐะฟัััะธ ััะพั ัะบัะธะฟั
  4. ะะพัะปะต ะฟะตัะฒะพะณะพ ะดะตะฟะปะพั ะฝะฐัััะพะน SSL

ะะะะฃะะะะขะะฆะะฏ:
  ๐ DEPLOY_FOR_BEGINNERS.md - ะะพะดัะพะฑะฝะฐั ะธะฝััััะบัะธั ะดะปั ะฝะพะฒะธัะบะพะฒ (ะะะะะะะะะฃะะขะกะฏ!)
  ๐ DEPLOY_TIMEWEB.md - ะะพะปะฝะพะต ััะบะพะฒะพะดััะฒะพ
  โก QUICK_START_TIMEWEB.md - ะัััััะน ััะฐัั
"
            exit 0
            ;;
        *)
            error "ะะตะธะทะฒะตััะฝัะน ะฟะฐัะฐะผะตัั: $1"
            echo "ะัะฟะพะปัะทัะน -h ะดะปั ัะฟัะฐะฒะบะธ"
            exit 1
            ;;
    esac
done

# ะัะพะฒะตัะบะฐ SERVER_IP
if [ -z "$SERVER_IP" ]; then
    error "โ ะัะธะฑะบะฐ: ะฝะต ัะบะฐะทะฐะฝ IP ะฐะดัะตั ัะตัะฒะตัะฐ!"
    warning "
ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./deploy.sh -s <IP_ะฐะดัะตั>
ะัะธะผะตั:        ./deploy.sh -s 85.192.34.56

ะะปั ัะฟัะฐะฒะบะธ:   ./deploy.sh -h
"
    exit 1
fi

info "
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ          ๐ DEPLOY TO TIMEWEB CLOUD                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
"

info "๐ ะะฐัะฐะผะตััั ะดะตะฟะปะพั:"
info "   ะกะตัะฒะตั: $SERVER_IP"
info "   ะัะพะฟัััะธัั build: $SKIP_BUILD"
echo ""

# ================================================================
# ะจะะ 1: BUILD
# ================================================================

if [ "$SKIP_BUILD" = false ]; then
    info "๐ฆ [1/4] Building production version..."

    if npm run build; then
        success "โ Build successful!"
    else
        error "โ Build failed!"
        exit 1
    fi
else
    warning "โญ๏ธ  [1/4] Skipping build..."
fi

# ================================================================
# ะจะะ 2: ะะะะะะะะ DIST
# ================================================================

info "๐ [2/4] Checking dist folder..."

if [ ! -d "dist" ]; then
    error "โ ะะฐะฟะบะฐ dist ะฝะต ะฝะฐะนะดะตะฝะฐ!"
    error "ะะฐะฟัััะธ: npm run build"
    exit 1
fi

FILE_COUNT=$(find dist -type f | wc -l)
if [ "$FILE_COUNT" -eq 0 ]; then
    error "โ ะะฐะฟะบะฐ dist ะฟัััะฐ!"
    exit 1
fi

success "โ Found $FILE_COUNT files in dist/"

# ================================================================
# ะจะะ 3: UPLOAD TO SERVER
# ================================================================

info "โฌ๏ธ  [3/4] Uploading to server $SERVER_IP..."
warning "   (ะขะตะฑั ะฟะพะฟัะพััั ะฒะฒะตััะธ ะฟะฐัะพะปั root ะพั ัะตัะฒะตัะฐ)"

SCP_COMMAND="scp -r dist/* root@${SERVER_IP}:/var/www/agile-mind-pro/"

info "   Executing: $SCP_COMMAND"
echo ""

if $SCP_COMMAND; then
    success "โ Files uploaded successfully!"
else
    error "โ Upload failed!"
    warning "
ะะพะทะผะพะถะฝัะต ะฟัะธัะธะฝั:
  1. ะะตะฒะตัะฝัะน IP ะฐะดัะตั ัะตัะฒะตัะฐ
  2. ะะตะฒะตัะฝัะน ะฟะฐัะพะปั
  3. ะะฐะฟะบะฐ /var/www/agile-mind-pro ะฝะต ัััะตััะฒัะตั ะฝะฐ ัะตัะฒะตัะต
  4. SSH ะฟะพัั ะทะฐะบััั firewall'ะพะผ

ะัะพะฒะตัั:
  - IP ะฐะดัะตั: $SERVER_IP
  - SSH ะฟะพะดะบะปััะตะฝะธะต: ssh root@$SERVER_IP
  - Firewall: ufw status (ะฝะฐ ัะตัะฒะตัะต)
"
    exit 1
fi

# ================================================================
# ะจะะ 4: ะคะะะะะฌะะะฏ ะะะะะะะะ
# ================================================================

info "๐ [4/4] Verifying deployment..."

# ะัะพะฒะตัะบะฐ ะดะพัััะฟะฝะพััะธ ัะตัะฒะตัะฐ
if ping -c 1 "$SERVER_IP" &> /dev/null; then
    success "โ Server is reachable"
else
    warning "โ๏ธ  Server $SERVER_IP ะฝะต ะพัะฒะตัะฐะตั ะฝะฐ ping"
    warning "   (ะญัะพ ะฝะพัะผะฐะปัะฝะพ ะตัะปะธ ICMP ะพัะบะปััะตะฝ ะฒ firewall)"
fi

# ================================================================
# ะะะขะะะ!
# ================================================================

success "
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ          โ DEPLOYMENT SUCCESSFUL!                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
"

info "๐ ะกะปะตะดัััะธะต ัะฐะณะธ:"
echo ""
info "1๏ธโฃ  ะัะพะฒะตัั ัะฐะนั (HTTP):"
info "   http://$SERVER_IP"
echo ""
info "2๏ธโฃ  ะัะปะธ ะตััั ะดะพะผะตะฝ, ะพัะบัะพะน:"
info "   http://ัะฒะพะน-ะดะพะผะตะฝ.ru"
echo ""
info "3๏ธโฃ  ะะฐัััะพะน SSL (ะตัะปะธ ะตัะต ะฝะต ัะดะตะปะฐะป):"
info "   ssh root@$SERVER_IP"
info "   certbot --nginx -d ัะฒะพะน-ะดะพะผะตะฝ.ru -d www.ัะฒะพะน-ะดะพะผะตะฝ.ru"
echo ""
info "4๏ธโฃ  ะะพัะปะต SSL ะพัะบัะพะตััั:"
info "   https://ัะฒะพะน-ะดะพะผะตะฝ.ru ๐"
echo ""
success "๐ ะะพัะพะฒะพ! ะัะธะปะพะถะตะฝะธะต ัะฐะทะฒะตัะฝััะพ ะฝะฐ ัะตัะฒะตัะต!"
echo ""
info "๐ ะะพะปะฝะฐั ะธะฝััััะบัะธั: DEPLOY_TIMEWEB.md"
info "โก ะััััะฐั ัะฟัะฐะฒะบะฐ: QUICK_START_TIMEWEB.md"
echo ""
